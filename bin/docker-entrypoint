#!/bin/bash
# ==================== エントリーポイントスクリプト ====================
# このスクリプトはDockerコンテナ起動時に最初に実行されます
# データベースの準備やサーバーPIDファイルの削除などを行います

# set -e: エラーが発生したらスクリプトを即座に終了
set -e

# ==================== サーバーPIDファイルの削除 ====================
# Railsサーバーの再起動時に「A server is already running」エラーを防ぐ
# tmp/pids/server.pid: 前回のプロセスIDが残っている場合に削除
rm -f /rails/tmp/pids/server.pid

# ==================== jemalloc の有効化 ====================
# jemalloc: メモリ使用量を削減し、レイテンシを改善するメモリアロケータ
# LD_PRELOAD: 共有ライブラリを優先的に読み込む環境変数
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

# ==================== 本番環境のみ: データベース準備 ====================
# RAILS_ENV=productionの場合のみ実行
if [ "$RAILS_ENV" = "production" ]; then
  echo "Production environment detected"
  echo "DATABASE_URL is set: ${DATABASE_URL:+yes}"
  
  # DATABASE_URL が設定されているか確認
  if [ -z "$DATABASE_URL" ]; then
    echo "ERROR: DATABASE_URL is not set!"
    exit 1
  fi
  
  echo "Running database migrations..."
  # db:prepare: データベースが存在しない場合は作成し、マイグレーションを実行
  # DISABLE_DATABASE_ENVIRONMENT_CHECK=1: 本番環境でのdb:prepareを許可
  DISABLE_DATABASE_ENVIRONMENT_CHECK=1 ./bin/rails db:prepare
fi

# ==================== コマンド実行 ====================
# exec: このスクリプトのプロセスを指定されたコマンドに置き換える
# "$@": Dockerfileの CMD で指定されたコマンドを実行
# 例: CMD ["./bin/rails", "server"] → ./bin/rails server が実行される
exec "$@"
